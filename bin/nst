#! /usr/bin/env python

import errno
from optparse import OptionParser
import os
from pprint import pprint
import glob

# try:
#     import nst
# except:
#     pass

import nst

# import nst.farm

def main():
    """
    usage:

    nst --style ../style/034_c.png
    --content ../renders/comp/cv_075_comp_v003_512k.*.png
    --mask ../renders/masks/17f.*.tif
    --opt ../renders/optImage/opt_v001.*.tif
    --out ../renders/output/034c/v001/034c_v001.*.png
    --frames 1038:1048 --iterations 500 --cweights 1.0 --clayers r42
    --slayers r12:r21:r31:r34:r41:r42:r43 --sweights 0.2:0.02:0.02:0.02:0.2:0.02:0.02
    """

    # to do - addd cli args for from_content (?)  why looks diff?

    p = OptionParser()
    p.add_option("", "--from-content", dest='from_content', action='store')
    p.add_option("", "--style", dest='style', action='store')
    p.add_option("", "--content", dest='content', action='store')
    p.add_option("", "--mask", dest='mask', action='store')
    p.add_option("", "--opt", dest='opt', action='store')
    p.add_option("", "--out", dest='out', action='store')
    p.add_option("", "--frames", dest='frames', action='store')
    p.add_option("", "--iterations", dest='iterations', action='store')
    p.add_option("", "--clayers", dest='clayers', action='store')
    p.add_option("", "--cweights", dest='cweights', action='store')
    p.add_option("", "--slayers", dest='slayers', action='store')
    p.add_option("", "--sweights", dest='sweights', action='store')
    p.add_option("", "--smasks", dest='smasks', action='store')
    p.add_option("", "--engine", dest='engine', action='store')

    opts, args = p.parse_args()

    from_content = eval(opts.from_content)

    if opts.frames:
        frames = eval_frames(opts.frames)

    engine = opts.engine
    print(20.1, engine)

    cweights = [float(x) for x in opts.cweights.split(':')]
    clayers = opts.clayers.split(':')
    sweights = [float(x) for x in opts.sweights.split(':')]
    slayers = opts.slayers.split(':')

    # if opts.smasks:
    #     smasks = opts.smasks.split(':')

    check_outputs(opts.out)

    inputs_to_check = []

    content = eval(opts.content)

    if opts.opt:
        inputs_to_check.append(opts.opt)
    if opts.mask:
        inputs_to_check.append(opts.mask)
    if content:
        inputs_to_check.append(opts.content)

    check_inputs(opts.style, inputs_to_check)
    output_dir = os.path.abspath(os.path.join(opts.out, os.path.pardir))

    try:
        os.makedirs(output_dir)
    except OSError as e:
        if e.errno != errno.EEXIST:
            raise
        pass
    # if opts.farm:
    #     nst.farm.conda.doit(opts)
    #     return
    #

    if opts.frames:
        for frame in frames:
            if opts.smasks:
                smasks = [x.replace("####", "%04d" % frame) if x else None for x in smasks]
            if content:
                content_ = opts.content.replace("####", "%04d" % frame)
            if opts.opt:
                opt_image_ = opts.opt.replace("####", "%04d" % frame)
            output_image_ = opts.out.replace("####", "%04d" % frame)
    
            style_layers = {}
    
            for sl in slayers:
                i = slayers.index(sl)
                if opts.smasks:
                    smasks = opts.smasks.split(':')
                    if smasks[i]:
                        style_layers[sl] = {'weight': sweights[i], 'mask': smasks[i]}
                else:
                    style_layers[sl] = {'weight': sweights[i]}
    
            style_imager = nst.StyleImager(style_layers, style_image=opts.style, content_image=content_)
            style_imager.from_content = from_content
            style_imager.iterations = opts.iterations
            style_imager.log_iterations = 100
            style_imager.content_weights = cweights
            style_imager.content_layers = clayers
            style_imager.content_masks = [None]
            style_imager.out = output_image_
            style_imager.engine = engine
    
            if opts.opt:
                style_imager.optimisation_image = opt_image_
    
            style_imager.write_exr(frame=frame)

    else:
        output_image_ = opts.out

        style_layers = {}

        for sl in slayers:
            i = slayers.index(sl)
            if opts.smasks:
                smasks = opts.smasks.split(':')
                if smasks[i]:
                    style_layers[sl] = {'weight': sweights[i], 'mask': smasks[i]}
            else:
                style_layers[sl] = {'weight': sweights[i]}

        if content:
            print(1.1)
            style_imager = nst.StyleImager(style_layers, style_image=opts.style, content_image=opts.content)
            style_imager.content_weights = cweights
            style_imager.content_layers = clayers
            style_imager.content_masks = [None]
        else:
            print(1.23, engine)
            style_imager = nst.StyleImager(style_layers, style_image=opts.style, engine=engine)
            style_imager.opt_x = 858
            style_imager.opt_y = 858

        print('foobar')

        print(123, from_content, engine)
        style_imager.from_content = from_content
        style_imager.iterations = opts.iterations
        style_imager.log_iterations = 100
        style_imager.out = output_image_

        if opts.opt:
            style_imager.optimisation_image = opt_image_

        style_imager.write_exr()



def check_inputs(style, inputs):
    assert os.path.isfile(style)

    for i in inputs:
        i = i.replace('####', '*')
        try:
            assert len(glob.glob(i)) > 0
        except:
            print('invalid input:', i)


def check_outputs(output):
    op = os.path
    output_rel_dir = op.relpath(op.join(output, op.pardir))
    if not os.path.isdir(output_rel_dir):
        os.makedirs(output_rel_dir)


def eval_frames(frames_list):
    """
    Return a list of all frame numbers to be rendered.
    Step means every nth frame.
    """
    frames = []

    for token1 in frames_list.split(';'):

        # check for individual frames
        try:
            int(token1)
            frames.append(int(token1))

        # check for frame ranges
        except ValueError:
            token2 = token1.split(':')
            if len(token2) != 2:
                continue
            start = token2[0]
            end = token2[1]
            step = 1

            token3 = end.split('%')
            if len(token3) == 2:
                end = token3[0]
                step = token3[1]

            frame_range = []
            for i in range(int(start), int(end)+1):
                frame_range.append(i)
            frames += frame_range[::int(step)]

    # remove any repeated frames
    unique_frames = list(set(frames))
    unique_frames.sort()
    return unique_frames


if __name__ == "__main__":
    main()
    
"""
nst --style ../style/034_c.png --content ../renders/comp/cv_075_comp_v003_512k.####.png --mask ../renders/masks/17f.####.tif --opt ../renders/optImage/opt_v001.####.tif --out ../renders/output/034c/v001/034c_v001.####.png --frames 1038:1048 --iterations 500 --cweights 1.0 --clayers r42 --slayers r12:r21:r31:r34:r41:r42:r43 --sweights 0.2:0.02:0.02:0.02:0.2:0.02:0.02 
"""
