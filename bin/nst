#! /usr/bin/env python

from optparse import OptionParser
import os
from pprint import pprint
import glob

import nst
import nst.farm

def main():
    """
    usage:

    nst --style ../style/034_c.png
    --content ../renders/comp/cv_075_comp_v003_512k.*.png
    --mask ../renders/masks/17f.*.tif
    --opt ../renders/optImage/opt_v001.*.tif
    --out ../renders/output/034c/v001/034c_v001.*.png
    --frames 1038:1048 --iterations 500 --cweights 1.0 --clayers r42
    --slayers r12:r21:r31:r34:r41:r42:r43 --sweights 0.2:0.02:0.02:0.02:0.2:0.02:0.02
    """

    # to do - addd cli args for from_content (?)  why looks diff?

    p = OptionParser()
    p.add_option("", "--from-content", dest='from_content', action='store_true')
    p.add_option("", "--style", dest='style', action='store')
    p.add_option("", "--content", dest='content', action='store')
    p.add_option("", "--mask", dest='mask', action='store')
    p.add_option("", "--opt", dest='opt', action='store')
    p.add_option("", "--out", dest='out', action='store')
    p.add_option("", "--frames", dest='frames', action='store')
    p.add_option("", "--iterations", dest='iterations', action='store')
    p.add_option("", "--clayers", dest='clayers', action='store')
    p.add_option("", "--cweights", dest='cweights', action='store')
    p.add_option("", "--slayers", dest='slayers', action='store')
    p.add_option("", "--sweights", dest='sweights', action='store')
    p.add_option("", "--smasks", dest='smasks', action='store')

    opts, args = p.parse_args()

    frames = eval_frames(opts.frames)

    cweights = [float(x) for x in opts.cweights.split(':')]
    clayers = opts.clayers.split(':')
    sweights = [float(x) for x in opts.sweights.split(':')]
    slayers = opts.slayers.split(':')

    if opts.smasks:
        smasks = opts.smasks.split(':')

    # check_outputs(opts.out)

    inputs_to_check = []

    if opts.opt:
        inputs_to_check.append(opts.opt)
    if opts.mask:
        inputs_to_check.append(opts.mask)
    if opts.content:
        inputs_to_check.append(opts.content)

    check_inputs(opts.style, inputs_to_check)


    for frame in frames:

        if opts.smasks:
            smasks = [x.replace("####", "%04d" % frame) if x else None for x in smasks]

        if opts.content:
            content_ = opts.content.replace("####", "%04d" % frame)

        if opts.opt:
            opt_image_ = opts.opt.replace("####", "%04d" % frame)

        output_image_ = opts.out.replace("####", "%04d" % frame)

        style_layers = {}

        for sl in slayers:
            i = slayers.index(sl)
            if opts.smasks:
                if smasks[i]:
                    style_layers[sl] = {'weight': sweights[i], 'mask': smasks[i]}
            else:
                style_layers[sl] = {'weight': sweights[i]}


        style_imager = nst.StyleImager(style_layers, style_image=opts.style, content_image=content_)
        style_imager.from_content = opts.from_content
        style_imager.iterations = opts.iterations
        style_imager.log_iterations = 100
        style_imager.content_weights = cweights
        style_imager.content_layers = clayers
        style_imager.content_masks = [None]
        style_imager.raw_weights = True

        if opts.opt:
            style_imager.optimisation_image = opt_image_

        img = style_imager.generate_image()
        img.save(output_image_)


def check_inputs(style, inputs):
    assert os.path.isfile(style)

    for i in inputs:
        i = i.replace('####', '*')
        try:
            assert len(glob.glob(i)) > 0
        except:
            print('invalid input:', i)


def check_outputs(output):
    op = os.path
    output_rel_dir = op.relpath(op.join(output, op.pardir))
    if not os.path.isdir(output_rel_dir):
        os.makedirs(output_rel_dir)



def eval_frames(frames_list):
    """
    Return a list of all frame numbers to be rendered.
    Step means every nth frame.
    """
    frames = []

    for token1 in frames_list.split(';'):

        # check for individual frames
        try:
            int(token1)
            frames.append(int(token1))

        # check for frame ranges
        except ValueError:
            token2 = token1.split(':')
            if len(token2) != 2:
                continue
            start = token2[0]
            end = token2[1]
            step = 1

            token3 = end.split('%')
            if len(token3) == 2:
                end = token3[0]
                step = token3[1]

            frame_range = []
            for i in range(int(start), int(end)+1):
                frame_range.append(i)
            frames += frame_range[::int(step)]

    # remove any repeated frames
    unique_frames = list(set(frames))
    unique_frames.sort()
    return unique_frames


if __name__ == "__main__":
    main()
    
"""
nst --style ../style/034_c.png --content ../renders/comp/cv_075_comp_v003_512k.####.png --mask ../renders/masks/17f.####.tif --opt ../renders/optImage/opt_v001.####.tif --out ../renders/output/034c/v001/034c_v001.####.png --frames 1038:1048 --iterations 500 --cweights 1.0 --clayers r42 --slayers r12:r21:r31:r34:r41:r42:r43 --sweights 0.2:0.02:0.02:0.02:0.2:0.02:0.02 
"""